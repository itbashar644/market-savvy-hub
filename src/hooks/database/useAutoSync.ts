
import { useState, useCallback, useEffect, useRef } from 'react';
import { useWildberriesSync } from './useWildberriesSync';
import { useOzonSync } from './useOzonSync';
import { useWildberriesStockUpdate } from './useWildberriesStockUpdate';
import { useOzonStockUpdate } from './useOzonStockUpdate';
import { useInventory } from './useInventory';
import { toast } from 'sonner';

interface SyncStatus {
  isRunning: boolean;
  lastProductSyncTime: Date | null;
  lastStockUpdateTime: Date | null;
  nextProductSyncTime: Date | null;
  nextStockUpdateTime: Date | null;
  productSyncInterval: number; // –≤ –º–∏–Ω—É—Ç–∞—Ö, 0 –æ–∑–Ω–∞—á–∞–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–æ
  stockUpdateInterval: number; // –≤ –º–∏–Ω—É—Ç–∞—Ö
}

export const useAutoSync = () => {
  const [status, setStatus] = useState<SyncStatus>(() => {
    // Restore state from localStorage on init
    const savedSettings = localStorage.getItem('autoSyncSettings');
    const savedStatus = localStorage.getItem('autoSyncStatus');
    
    const defaultStatus: SyncStatus = {
      isRunning: false,
      lastProductSyncTime: null,
      lastStockUpdateTime: null,
      nextProductSyncTime: null,
      nextStockUpdateTime: null,
      productSyncInterval: 60,
      stockUpdateInterval: 30,
    };

    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      defaultStatus.productSyncInterval = settings.productSyncInterval === 'never' ? 0 : parseInt(settings.productSyncInterval || '60');
      defaultStatus.stockUpdateInterval = parseInt(settings.stockUpdateInterval || '30');
    }

    if (savedStatus) {
      const parsedStatus = JSON.parse(savedStatus);
      return {
        ...defaultStatus,
        isRunning: parsedStatus.isRunning || false,
        lastProductSyncTime: parsedStatus.lastProductSyncTime ? new Date(parsedStatus.lastProductSyncTime) : null,
        lastStockUpdateTime: parsedStatus.lastStockUpdateTime ? new Date(parsedStatus.lastStockUpdateTime) : null,
      };
    }

    return defaultStatus;
  });

  const { syncProducts: syncWbProducts } = useWildberriesSync();
  const { syncProducts: syncOzonProducts } = useOzonSync();
  const { updateStock: updateWbStock } = useWildberriesStockUpdate();
  const { updateStock: updateOzonStock } = useOzonStockUpdate();
  const { inventory } = useInventory();

  const productSyncIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const stockUpdateIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const isRunningRef = useRef(false);

  // Save status to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem('autoSyncStatus', JSON.stringify({
      isRunning: status.isRunning,
      lastProductSyncTime: status.lastProductSyncTime,
      lastStockUpdateTime: status.lastStockUpdateTime,
    }));
    isRunningRef.current = status.isRunning;
  }, [status]);

  // Function to get stock updates from inventory for sending to marketplaces
  const getStockUpdatesFromInventory = useCallback(() => {
    console.log('Getting stock updates from inventory. Total items:', inventory.length);
    
    const updates = inventory
      .filter(item => {
        const hasWbSku = item.wildberries_sku && item.wildberries_sku.trim() !== '';
        if (hasWbSku) {
          console.log(`Item ${item.sku}: WB SKU = ${item.wildberries_sku}, stock = ${item.currentStock}`);
        }
        return hasWbSku;
      })
      .map(item => ({
        nm_id: parseInt(item.wildberries_sku!),
        warehouse_id: 1,
        stock: item.currentStock,
        offer_id: item.sku,
        sku: item.sku
      }));
    
    console.log('Prepared stock updates for WB:', updates.length, 'items');
    return updates;
  }, [inventory]);

  // Perform product synchronization
  const performProductSync = useCallback(async () => {
    if (!isRunningRef.current || status.productSyncInterval === 0) {
      console.log('Product sync skipped - not running or interval is 0');
      return;
    }

    try {
      console.log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤...');
      
      // Sync Wildberries
      try {
        await syncWbProducts();
        console.log('‚úÖ Wildberries —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Wildberries:', error);
        toast.error('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Wildberries: ' + (error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
      
      // Sync Ozon
      try {
        await syncOzonProducts();
        console.log('‚úÖ Ozon —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
      } catch (error) {
        console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Ozon:', error);
        // Don't show Ozon errors as they might be normal if no settings
      }
      
      const now = new Date();
      setStatus(prev => ({
        ...prev,
        lastProductSyncTime: now,
        nextProductSyncTime: prev.productSyncInterval > 0 ? new Date(now.getTime() + prev.productSyncInterval * 60 * 1000) : null
      }));

      toast.success('‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
      toast.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤: ' + (error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  }, [status.productSyncInterval, syncWbProducts, syncOzonProducts]);

  // Perform stock update
  const performStockUpdate = useCallback(async () => {
    if (!isRunningRef.current) {
      console.log('Stock update skipped - not running');
      return;
    }

    try {
      console.log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤...');
      const stockUpdates = getStockUpdatesFromInventory();
      
      if (stockUpdates.length === 0) {
        console.log('‚ö†Ô∏è –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å Wildberries SKU –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤');
        const now = new Date();
        setStatus(prev => ({
          ...prev,
          lastStockUpdateTime: now,
          nextStockUpdateTime: new Date(now.getTime() + prev.stockUpdateInterval * 60 * 1000)
        }));
        toast.info('‚ÑπÔ∏è –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤');
        return;
      }

      console.log('üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤:', stockUpdates.length);

      let successCount = 0;
      let errorCount = 0;

      // Update Wildberries stock
      try {
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ Wildberries...');
        await updateWbStock(stockUpdates);
        console.log('‚úÖ –û—Å—Ç–∞—Ç–∫–∏ Wildberries –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        successCount++;
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ Wildberries:', error);
        errorCount++;
        toast.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ Wildberries: ' + (error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      }
      
      // Update Ozon stock
      try {
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ Ozon...');
        await updateOzonStock(stockUpdates);
        console.log('‚úÖ –û—Å—Ç–∞—Ç–∫–∏ Ozon –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ');
        successCount++;
      } catch (error) {
        console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ Ozon:', error);
        // Don't show Ozon errors as they might be normal if no settings
      }
      
      const now = new Date();
      setStatus(prev => ({
        ...prev,
        lastStockUpdateTime: now,
        nextStockUpdateTime: new Date(now.getTime() + prev.stockUpdateInterval * 60 * 1000)
      }));

      if (successCount > 0) {
        toast.success(`‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (${stockUpdates.length} —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ ${successCount} –ø–ª–æ—â–∞–¥–∫–∞—Ö)`);
      } else if (errorCount > 0) {
        toast.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–µ');
      }
    } catch (error) {
      console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤:', error);
      toast.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤: ' + (error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  }, [getStockUpdatesFromInventory, updateWbStock, updateOzonStock]);

  // Start auto-sync
  const startAutoSync = useCallback(() => {
    if (isRunningRef.current) {
      console.log('üîÑ Auto-sync already running, skipping start');
      return;
    }

    console.log('üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...');
    console.log('üìã –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:', {
      productSyncInterval: status.productSyncInterval,
      stockUpdateInterval: status.stockUpdateInterval
    });

    setStatus(prev => ({ ...prev, isRunning: true }));

    // Set intervals immediately after setting state
    setTimeout(() => {
      if (status.productSyncInterval > 0) {
        // Perform first product sync after 5 seconds
        setTimeout(performProductSync, 5000);
        
        // Set interval for product sync
        productSyncIntervalRef.current = setInterval(
          performProductSync,
          status.productSyncInterval * 60 * 1000
        );
        console.log(`üìÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${status.productSyncInterval} –º–∏–Ω—É—Ç`);
      }

      // Perform first stock update after 10 seconds
      setTimeout(performStockUpdate, 10000);
      
      // Set interval for stock updates
      stockUpdateIntervalRef.current = setInterval(
        performStockUpdate,
        status.stockUpdateInterval * 60 * 1000
      );
      console.log(`üìÖ –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${status.stockUpdateInterval} –º–∏–Ω—É—Ç`);

      // Set next execution times
      const now = new Date();
      setStatus(prev => ({
        ...prev,
        nextProductSyncTime: prev.productSyncInterval > 0 ? new Date(now.getTime() + prev.productSyncInterval * 60 * 1000) : null,
        nextStockUpdateTime: new Date(now.getTime() + prev.stockUpdateInterval * 60 * 1000)
      }));
    }, 1000);

    toast.success('‚úÖ –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
  }, [status.productSyncInterval, status.stockUpdateInterval, performProductSync, performStockUpdate]);

  // Stop auto-sync
  const stopAutoSync = useCallback(() => {
    console.log('‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...');
    
    if (productSyncIntervalRef.current) {
      clearInterval(productSyncIntervalRef.current);
      productSyncIntervalRef.current = null;
      console.log('‚èπÔ∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    if (stockUpdateIntervalRef.current) {
      clearInterval(stockUpdateIntervalRef.current);
      stockUpdateIntervalRef.current = null;
      console.log('‚èπÔ∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    setStatus(prev => ({
      ...prev,
      isRunning: false,
      nextProductSyncTime: null,
      nextStockUpdateTime: null
    }));

    toast.info('‚è∏Ô∏è –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
  }, []);

  // Update intervals
  const updateIntervals = useCallback((productInterval: number, stockInterval: number) => {
    console.log('üîß Updating intervals:', { productInterval, stockInterval });
    
    setStatus(prev => ({
      ...prev,
      productSyncInterval: productInterval,
      stockUpdateInterval: stockInterval
    }));

    // If sync is running, restart with new intervals
    if (isRunningRef.current) {
      console.log('üîÑ Restarting auto-sync with new intervals');
      stopAutoSync();
      setTimeout(() => {
        startAutoSync();
      }, 2000);
    }
  }, [stopAutoSync, startAutoSync]);

  // Restore auto-sync on component mount if it was previously running
  useEffect(() => {
    const savedSettings = localStorage.getItem('autoSyncSettings');
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      if (settings.autoSyncEnabled && !isRunningRef.current) {
        console.log('üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ localStorage');
        setTimeout(() => {
          startAutoSync();
        }, 3000);
      }
    }
  }, [startAutoSync]);

  // Cleanup intervals on unmount
  useEffect(() => {
    return () => {
      console.log('üßπ Cleanup intervals on unmount');
      if (productSyncIntervalRef.current) {
        clearInterval(productSyncIntervalRef.current);
      }
      if (stockUpdateIntervalRef.current) {
        clearInterval(stockUpdateIntervalRef.current);
      }
    };
  }, []);

  return {
    status,
    startAutoSync,
    stopAutoSync,
    updateIntervals,
    performProductSync,
    performStockUpdate,
    getStockUpdatesFromInventory,
  };
};
